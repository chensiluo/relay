<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿œç¨‹ç»§ç”µå™¨æ§åˆ¶ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script src="index_config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            display: flex;
            min-height: 600px;
            height: calc(100vh - 40px);
        }

        /* å·¦ä¾§è®¾å¤‡åˆ—è¡¨æ ·å¼ */
        .device-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .sidebar-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .add-device-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .add-device-btn:hover {
            background: #2980b9;
        }

        .device-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .device-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .device-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .device-item.active {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .device-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .device-id {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .device-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator-small {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator-small.online {
            background: #2ecc71;
        }

        .status-indicator-large {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator-large.online {
            background: #2ecc71;
        }

        .status-text {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .device-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .device-item:hover .device-actions {
            opacity: 1;
        }

        .device-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .device-item:hover .device-actions {
            opacity: 1;
        }

        .device-item-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background 0.3s ease;
        }

        .device-item-btn:hover {
            background: #3498db;
            color: white;
        }

        .device-item-btn.edit {
            background: #f39c12;
            color: white;
        }

        .device-item-btn.delete {
            background: #e74c3c;
            color: white;
        }

        /* å³ä¾§ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* é¡µé¢å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* è®¾å¤‡æ§åˆ¶åŒºåŸŸ */
        .control-section {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        /* è®¾å¤‡å¤´éƒ¨æ ·å¼ */
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .device-header h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin: 0;
            font-weight: 600;
        }

        .device-header-actions {
            display: flex;
            gap: 10px;
        }

        .device-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
            white-space: nowrap;
            height: 40px;
        }

        .device-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .device-btn.edit {
            background: #f39c12;
        }

        .device-btn.edit:hover {
            background: #e67e22;
        }

        .device-btn.config {
            background: #9b59b6;
        }

        .device-btn.config:hover {
            background: #8e44ad;
        }

        .device-btn.delete {
            background: #e74c3c;
        }

        .device-btn.delete:hover {
            background: #c0392b;
        }

        .device-btn.refresh {
            background: #2ecc71;
        }

        .device-btn.refresh:hover {
            background: #27ae60;
        }

        .device-btn.restart {
            background: #f39c12;
        }

        .device-btn.restart:hover {
            background: #e67e22;
        }

        /* ç»§ç”µå™¨æ§åˆ¶é¢æ¿ */
        .relay-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .no-device-selected {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
            font-size: 1.2rem;
            grid-column: 1 / -1;
        }

        /* ç»§ç”µå™¨æ§åˆ¶å¡æ ·å¼ */
        .relay-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        .relay-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .relay-card.active {
            border-color: #3498db;
        }

        .relay-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .relay-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .relay-title:hover {
            color: #3498db;
        }

        .relay-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }

        .relay1-icon {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .relay2-icon {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        }

        .relay-state {
            text-align: center;
            margin: 20px 0;
        }

        .state-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .state-led {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #95a5a6;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(149, 165, 166, 0.3);
        }

        .state-led.on {
            background: #2ecc71;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.6);
            animation: pulse 2s infinite;
        }

        .state-led.off {
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(46, 204, 113, 0.6); }
            50% { box-shadow: 0 0 25px rgba(46, 204, 113, 0.8); }
            100% { box-shadow: 0 0 20px rgba(46, 204, 113, 0.6); }
        }

        .state-text {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            background: #f8f9fa;
            color: #2c3e50;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .state-text.on {
            background: #d5f4e6;
            color: #27ae60;
            border-color: #2ecc71;
        }

        .state-text.off {
            background: #fadbd8;
            color: #c0392b;
            border-color: #e74c3c;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-on {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-on:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-off {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
        }

        .btn-off:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-toggle {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: white;
            grid-column: 1 / -1;
        }

        .btn-toggle:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: white;
            margin-top: auto;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .form-notice {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .device-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                height: 300px; /* å›ºå®šé«˜åº¦ */
            }
            
            .device-list {
                height: 260px; /* è®¾ç½®åˆ—è¡¨é«˜åº¦ï¼Œç•™å‡ºæ ‡é¢˜ç©ºé—´ */
                overflow-y: auto; /* å‚ç›´æ»šåŠ¨ */
            }
            
            .relay-controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.1rem;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            /* æ‰‹æœºç«¯ç»§ç”µå™¨æ§åˆ¶åŒºåŸŸä¼˜åŒ– */
            .device-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .device-header h2 {
                text-align: center;
                font-size: 1rem;
            }
            
            .device-header-actions {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§è®¾å¤‡åˆ—è¡¨ -->
        <div class="device-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ğŸ“± è®¾å¤‡åˆ—è¡¨</div>
                <button class="add-device-btn" onclick="showAddDeviceModal()">+ æ·»åŠ è®¾å¤‡</button>
            </div>
            <div class="device-list" id="deviceList">
                <!-- è®¾å¤‡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡µé¢å¤´éƒ¨ -->
            <div class="header">
                <div class="header-controls">
                    <button class="header-btn" onclick="showMqttConfig()">âš™ï¸ MQTTè®¾ç½®</button>
                </div>
                <h1>ğŸ”Œ è¿œç¨‹ç»§ç”µå™¨æ§åˆ¶ç³»ç»Ÿ</h1>
                <p>åŸºäº MQTT åè®®çš„ç‰©è”ç½‘è®¾å¤‡è¿œç¨‹æ§åˆ¶</p>
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">è¿æ¥æ–­å¼€</span>
                </div>
            </div>

            <!-- è®¾å¤‡æ§åˆ¶åŒºåŸŸ -->
            <div class="control-section">
                <!-- å½“å‰è®¾å¤‡ä¿¡æ¯æ  -->
                <div class="device-header">
                    <h2 id="currentDeviceName">è¯·é€‰æ‹©è®¾å¤‡</h2>
                    <div class="device-header-actions">
                        <button class="device-btn edit" onclick="editDeviceInfo()" id="editDeviceBtn">âœï¸ ç¼–è¾‘ä¿¡æ¯</button>
                        <!-- ä¸‹å‘é…ç½®æŒ‰é’®å·²éšè— -->
                        <!-- <button class="device-btn config" onclick="sendDeviceConfig()" id="configDeviceBtn">âš™ï¸ ä¸‹å‘é…ç½®</button> -->
                        <button class="device-btn restart" onclick="restartDevice()" id="restartDeviceBtn">ğŸ”„ é‡å¯è®¾å¤‡</button>
                        <button class="device-btn delete" onclick="removeCurrentDevice()" id="removeDeviceBtn">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>

                <!-- ç»§ç”µå™¨æ§åˆ¶é¢æ¿ -->
                <div class="relay-controls" id="relayControls">
                    <div class="no-device-selected">
                        <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡</p>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p>Â© 2025 è¿œç¨‹å¤šè®¾å¤‡å¤šç»§ç”µå™¨æ§åˆ¶ç³»ç»Ÿ </p>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥åŒºåŸŸ -->
    <div class="notification" id="notification"></div>

    <!-- MQTTé…ç½®å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="mqttConfigModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">âš™ï¸ MQTTæœåŠ¡å™¨é…ç½®</h3>
                <button class="modal-close" onclick="hideMqttConfig()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">æœåŠ¡å™¨åœ°å€</label>
                <input type="text" class="form-input" id="mqttHost" placeholder="mqttæœåŠ¡å™¨åœ°å€">
            </div>
            <div class="form-group">
                <label class="form-label">ç«¯å£å·</label>
                <input type="number" class="form-input" id="mqttPort" placeholder="WebSocketç«¯å£">
            </div>
            <div class="form-group">
                <label class="form-label">è·¯å¾„ (å¯é€‰)</label>
                <input type="text" class="form-input" id="mqttPath" placeholder="mqtt">
            </div>
            <div class="form-group">
                <label class="form-label">ç”¨æˆ·å</label>
                <input type="text" class="form-input" id="mqttUser" placeholder="ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label class="form-label">å¯†ç </label>
                <input type="password" class="form-input" id="mqttPassword" placeholder="å¯†ç ">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" class="form-checkbox" id="mqttSSL">
                    å¯ç”¨SSLåŠ å¯†
                </label>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideMqttConfig()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveMqttConfig()">ä¿å­˜å¹¶è¿æ¥</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="addDeviceModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“± æ·»åŠ æ–°è®¾å¤‡</h3>
                <button class="modal-close" onclick="hideAddDeviceModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">è®¾å¤‡åç§°</label>
                <input type="text" class="form-input" id="deviceNameInput" placeholder="è¾“å…¥è®¾å¤‡åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">è®¾å¤‡ID (IMEI)</label>
                <input type="text" class="form-input" id="deviceIdInput" placeholder="è¾“å…¥è®¾å¤‡IMEIç ">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddDeviceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveNewDevice()">ä¿å­˜è®¾å¤‡</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è®¾å¤‡å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="editDeviceModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">âœï¸ ç¼–è¾‘è®¾å¤‡</h3>
                <button class="modal-close" onclick="hideEditDeviceModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">è®¾å¤‡åç§°</label>
                <input type="text" class="form-input" id="editDeviceNameInput" placeholder="è¾“å…¥è®¾å¤‡åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">è®¾å¤‡ID (IMEI)</label>
                <input type="text" class="form-input" id="editDeviceIdInput" placeholder="è®¾å¤‡IMEIç " readonly>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideEditDeviceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEditedDevice()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- ç»§ç”µå™¨åç§°ç¼–è¾‘å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="relayNameModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“ ä¿®æ”¹ç»§ç”µå™¨åç§°</h3>
                <button class="modal-close" onclick="hideRelayName()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">ç»§ç”µå™¨ <span id="editingRelayNum">1</span> çš„æ–°åç§°</label>
                <input type="text" class="form-input" id="relayNameInput" placeholder="è¾“å…¥ç»§ç”µå™¨åç§°">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideRelayName()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveRelayName()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç»§ç”µå™¨å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="addRelayModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”Œ æ·»åŠ ç»§ç”µå™¨</h3>
                <button class="modal-close" onclick="hideAddRelayModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">ç»§ç”µå™¨åç§°</label>
                <input type="text" class="form-input" id="addRelayNameInput" placeholder="è¾“å…¥ç»§ç”µå™¨åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">GPIOå£ç¼–å·</label>
                <input type="number" class="form-input" id="addRelayGpioInput" placeholder="è¾“å…¥GPIOå£ç¼–å·">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddRelayModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveNewRelay()">æ·»åŠ ç»§ç”µå™¨</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ç»§ç”µå™¨å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="editRelayModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">âœï¸ ç¼–è¾‘ç»§ç”µå™¨</h3>
                <button class="modal-close" onclick="hideEditRelayModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">ç»§ç”µå™¨åç§°</label>
                <input type="text" class="form-input" id="editRelayNameInput" placeholder="è¾“å…¥ç»§ç”µå™¨åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">GPIOå£ç¼–å·</label>
                <input type="number" class="form-input" id="editRelayGpioInput" placeholder="è¾“å…¥GPIOå£ç¼–å·">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideEditRelayModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEditedRelay()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- é…ç½®ä¸‹å‘å¯¹è¯æ¡†å·²ç§»é™¤ -->

    <script>
        // DEFAULT_CONFIG å·²ç§»è‡³ config.js

        // å…¨å±€å˜é‡
        let mqttClient = null;
        let currentDeviceId = ''; // å½“å‰é€‰ä¸­çš„è®¾å¤‡ID
        let isConnected = false;
        let config = {...DEFAULT_CONFIG};
        
        // è®¾å¤‡ç®¡ç†
        let devices = [];
        let deviceStatus = {}; // è®¾å¤‡åœ¨çº¿çŠ¶æ€ {'device_id': {online: true, lastPing: timestamp}}
        
        // ç»§ç”µå™¨ç®¡ç†ï¼ˆæ¯ä¸ªè®¾å¤‡æœ‰ç‹¬ç«‹çš„ç»§ç”µå™¨åˆ—è¡¨ï¼‰
        let deviceRelays = {}; // {'device_id': [relay1, relay2, ...]}

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            console.log('åˆå§‹åŒ–è¿œç¨‹å¤šè®¾å¤‡å¤šç»§ç”µå™¨æ§åˆ¶ç³»ç»Ÿ...');
            loadConfig();
            loadDevices();
            loadRelays();
            setupEventListeners();
            
            // å¯åŠ¨å¿ƒè·³è¶…æ—¶æ£€æµ‹å®šæ—¶å™¨ï¼ˆæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(checkDeviceTimeout, 5000);
            
            // æ£€æŸ¥MQTTé…ç½®æ˜¯å¦å®Œæ•´
            if (!isConfigComplete()) {
                showNotification('è¯·å…ˆé…ç½® MQTT æœåŠ¡å™¨', 'info');
                showMqttConfig(); // è‡ªåŠ¨æ˜¾ç¤ºé…ç½®å¯¹è¯æ¡†
                return;
            }
            
            // ç­‰å¾…MQTTåº“åŠ è½½å®Œæˆ
            if (typeof mqtt !== 'undefined') {
                connectMQTT();
            } else {
                console.log('ç­‰å¾…MQTTåº“åŠ è½½...');
                setTimeout(() => {
                    if (typeof mqtt !== 'undefined') {
                        connectMQTT();
                    } else {
                        showNotification('MQTTåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                    }
                }, 2000);
            }
        }

        // é…ç½®ç®¡ç†å‡½æ•°
        function loadConfig() {
            const saved = localStorage.getItem('relay_control_config');
            if (saved) {
                try {
                    config = {...DEFAULT_CONFIG, ...JSON.parse(saved)};
                    console.log('é…ç½®å·²åŠ è½½:', config);
                } catch (e) {
                    console.error('é…ç½®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', e);
                    config = {...DEFAULT_CONFIG};
                }
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
                config = {...DEFAULT_CONFIG};
                console.log('ä½¿ç”¨é»˜è®¤é…ç½®:', config);
            }
        }

        // æ£€æŸ¥MQTTé…ç½®æ˜¯å¦å®Œæ•´
        function isConfigComplete() {
            return config.mqtt_host && 
                   config.mqtt_port && 
                   config.mqtt_user && 
                   config.mqtt_pwd;
        }

        function saveConfig() {
            localStorage.setItem('relay_control_config', JSON.stringify(config));
            console.log('é…ç½®å·²ä¿å­˜:', config);
        }

        // è®¾å¤‡ç®¡ç†å‡½æ•°
        function loadDevices() {
            const saved = localStorage.getItem('relay_control_devices');
            if (saved) {
                try {
                    devices = JSON.parse(saved);
                    console.log('è®¾å¤‡åˆ—è¡¨å·²åŠ è½½:', devices);
                    renderDeviceList();
                    
                    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªè®¾å¤‡
                    if (devices.length > 0) {
                        selectDevice(devices[0].id);
                    }
                } catch (e) {
                    console.error('è®¾å¤‡åˆ—è¡¨åŠ è½½å¤±è´¥:', e);
                    devices = [];
                }
            }
        }

        function saveDevices() {
            localStorage.setItem('relay_control_devices', JSON.stringify(devices));
            console.log('è®¾å¤‡åˆ—è¡¨å·²ä¿å­˜:', devices);
        }

        function saveRelays() {
            localStorage.setItem('relay_control_relays', JSON.stringify(deviceRelays));
            console.log('ç»§ç”µå™¨é…ç½®å·²ä¿å­˜:', deviceRelays);
        }

        function loadRelays() {
            const saved = localStorage.getItem('relay_control_relays');
            if (saved) {
                try {
                    deviceRelays = JSON.parse(saved);
                    console.log('ç»§ç”µå™¨é…ç½®å·²åŠ è½½:', deviceRelays);
                    console.log('è®¾å¤‡æ•°é‡:', Object.keys(deviceRelays).length);
                    for (const deviceId in deviceRelays) {
                        console.log(`è®¾å¤‡ ${deviceId} çš„ç»§ç”µå™¨æ•°é‡:`, deviceRelays[deviceId].length);
                    }
                } catch (e) {
                    console.error('ç»§ç”µå™¨é…ç½®åŠ è½½å¤±è´¥:', e);
                    deviceRelays = {};
                }
            } else {
                console.log('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„ç»§ç”µå™¨é…ç½®ï¼Œä½¿ç”¨é»˜è®¤ç©ºé…ç½®');
                deviceRelays = {};
            }
        }

        // ç»§ç”µå™¨ç®¡ç†å‡½æ•°
        function getCurrentDeviceRelays() {
            if (!currentDeviceId) return [];
            return deviceRelays[currentDeviceId] || [];
        }

        function showAddRelayModal() {
            if (!currentDeviceId) {
                showNotification('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'error');
                return;
            }
            
            document.getElementById('addRelayNameInput').value = '';
            document.getElementById('addRelayGpioInput').value = '';
            document.getElementById('addRelayModal').classList.add('show');
        }

        function hideAddRelayModal() {
            document.getElementById('addRelayModal').classList.remove('show');
        }

        function saveNewRelay() {
            if (!currentDeviceId) {
                showNotification('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'error');
                return;
            }
            
            const name = document.getElementById('addRelayNameInput').value.trim();
            const gpio = parseInt(document.getElementById('addRelayGpioInput').value);
            
            if (!name) {
                showNotification('è¯·è¾“å…¥ç»§ç”µå™¨åç§°', 'error');
                return;
            }
            
            if (isNaN(gpio) || gpio <= 0) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„GPIOå£ç¼–å·', 'error');
                return;
            }
            
            // æ£€æŸ¥GPIOå£æ˜¯å¦å·²å­˜åœ¨
            const relays = getCurrentDeviceRelays();
            if (relays.some(relay => relay.gpio === gpio)) {
                showNotification('è¯¥GPIOå£å·²è¢«å ç”¨', 'error');
                return;
            }
            
            const newRelay = {
                id: Date.now().toString(),
                name: name,
                gpio: gpio,
                state: false
            };
            
            if (!deviceRelays[currentDeviceId]) {
                deviceRelays[currentDeviceId] = [];
            }
            
            deviceRelays[currentDeviceId].push(newRelay);
            
            console.log(`[ç»§ç”µå™¨ç®¡ç†] æ·»åŠ æ–°ç»§ç”µå™¨:`, {
                deviceId: currentDeviceId,
                relay: newRelay,
                totalRelays: deviceRelays[currentDeviceId].length
            });
            
            saveRelays();
            hideAddRelayModal();
            renderRelayControls();
            showNotification('ç»§ç”µå™¨æ·»åŠ æˆåŠŸ', 'success');
        }

        function showEditRelayModal(relayId) {
            if (!currentDeviceId) return;
            
            const relays = getCurrentDeviceRelays();
            const relay = relays.find(r => r.id === relayId);
            
            if (relay) {
                document.getElementById('editRelayNameInput').value = relay.name;
                document.getElementById('editRelayGpioInput').value = relay.gpio;
                document.getElementById('editRelayModal').dataset.editingRelayId = relayId;
                document.getElementById('editRelayModal').classList.add('show');
            }
        }

        function hideEditRelayModal() {
            document.getElementById('editRelayModal').classList.remove('show');
        }

        function saveEditedRelay() {
            if (!currentDeviceId) {
                showNotification('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'error');
                return;
            }
            
            const relayId = document.getElementById('editRelayModal').dataset.editingRelayId;
            const relays = getCurrentDeviceRelays();
            const relayIndex = relays.findIndex(r => r.id === relayId);
            
            if (relayIndex === -1) {
                showNotification('ç»§ç”µå™¨ä¸å­˜åœ¨', 'error');
                return;
            }
            
            const name = document.getElementById('editRelayNameInput').value.trim();
            const gpio = parseInt(document.getElementById('editRelayGpioInput').value);
            
            if (!name) {
                showNotification('è¯·è¾“å…¥ç»§ç”µå™¨åç§°', 'error');
                return;
            }
            
            if (isNaN(gpio) || gpio <= 0) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„GPIOå£ç¼–å·', 'error');
                return;
            }
            
            // æ£€æŸ¥GPIOå£æ˜¯å¦è¢«å…¶ä»–ç»§ç”µå™¨å ç”¨
            if (relays.some((r, index) => r.gpio === gpio && index !== relayIndex)) {
                showNotification('è¯¥GPIOå£å·²è¢«å ç”¨', 'error');
                return;
            }
            
            deviceRelays[currentDeviceId][relayIndex].name = name;
            deviceRelays[currentDeviceId][relayIndex].gpio = gpio;
            
            const updatedRelay = deviceRelays[currentDeviceId][relayIndex];
            console.log(`[ç»§ç”µå™¨ç®¡ç†] ç¼–è¾‘ç»§ç”µå™¨:`, {
                deviceId: currentDeviceId,
                relayId: relayId,
                updatedRelay: updatedRelay,
                changes: { name, gpio }
            });
            
            saveRelays();
            hideEditRelayModal();
            renderRelayControls();
            showNotification('ç»§ç”µå™¨ä¿¡æ¯å·²æ›´æ–°', 'success');
        }

        function deleteRelay(relayId) {
            if (!currentDeviceId) return;
            
            const relays = getCurrentDeviceRelays();
            const relay = relays.find(r => r.id === relayId);
            
            if (relay && confirm(`ç¡®å®šè¦åˆ é™¤ç»§ç”µå™¨"${relay.name}"å—ï¼Ÿ`)) {
                deviceRelays[currentDeviceId] = relays.filter(r => r.id !== relayId);
                
                console.log(`[ç»§ç”µå™¨ç®¡ç†] åˆ é™¤ç»§ç”µå™¨:`, {
                    deviceId: currentDeviceId,
                    deletedRelay: relay,
                    remainingRelays: deviceRelays[currentDeviceId].length
                });
                
                saveRelays();
                renderRelayControls();
                showNotification('ç»§ç”µå™¨å·²åˆ é™¤', 'success');
            }
        }

        function renderDeviceList() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';
            
            devices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = `device-item ${device.id === currentDeviceId ? 'active' : ''}`;
                deviceItem.onclick = () => selectDevice(device.id);
                
                const isOnline = deviceStatus[device.id] && deviceStatus[device.id].online;
                
                deviceItem.innerHTML = `
                    <div class="device-actions">
                        <button class="device-item-btn edit" onclick="editDevice('${device.id}', event)" title="ç¼–è¾‘">âœï¸</button>
                        <button class="device-item-btn delete" onclick="deleteDevice('${device.id}', event)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                    <div class="device-name">${device.name}</div>
                    <div class="device-id">ID: ${device.id}</div>
                    <div class="device-status">
                        <div class="status-indicator-large ${isOnline ? 'online' : 'offline'}" title="${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}"></div>
                    </div>
                `;
                
                deviceList.appendChild(deviceItem);
            });
        }

        function selectDevice(deviceId) {
            currentDeviceId = deviceId;
            const device = devices.find(d => d.id === deviceId);
            
            console.log(`[è®¾å¤‡é€‰æ‹©] é€‰æ‹©è®¾å¤‡:`, {
                deviceId: deviceId,
                deviceName: device ? device.name : 'æœªçŸ¥',
                currentDeviceId: currentDeviceId
            });
            
            if (device) {
                document.getElementById('currentDeviceName').textContent = device.name;
                renderRelayControls(device);
            }
            
            renderDeviceList();
        }

        function renderRelayControls(device) {
            const relayControls = document.getElementById('relayControls');
            
            if (!currentDeviceId) {
                relayControls.innerHTML = '<div class="no-device-selected"><p>è¯·åœ¨å·¦ä¾§é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡</p></div>';
                return;
            }
            
            const relays = getCurrentDeviceRelays();
            
            if (relays.length === 0) {
                relayControls.innerHTML = `
                    <div class="no-device-selected">
                        <p>å½“å‰è®¾å¤‡æ²¡æœ‰é…ç½®ç»§ç”µå™¨</p>
                        <button class="device-btn" onclick="showAddRelayModal()" style="margin-top: 15px;">
                            â• æ·»åŠ ç¬¬ä¸€ä¸ªç»§ç”µå™¨
                        </button>
                    </div>
                `;
                return;
            }
            
            // åŠ¨æ€ç”Ÿæˆç»§ç”µå™¨å¡ç‰‡
            const relayCards = relays.map(relay => {
                const relayIconClass = `relay${(relays.indexOf(relay) % 2) + 1}-icon`;
                const stateClass = relay.state ? 'on' : 'off';
                const stateText = relay.state ? 'è®¾å¤‡è¿è¡Œä¸­' : 'è®¾å¤‡å·²å…³é—­';
                
                return `
                    <div class="relay-card" id="relay${relay.id}Card">
                        <div class="relay-header">
                            <div class="relay-title" onclick="showEditRelayModal('${relay.id}')">${relay.name}</div>
                            <div class="relay-icon ${relayIconClass}">ğŸ”Œ</div>
                        </div>
                        <div class="relay-state">
                            <div class="state-indicator">
                                <div class="state-led ${stateClass}" id="relay${relay.id}Led"></div>
                                <span class="state-text ${stateClass}" id="relay${relay.id}State">${stateText}</span>
                            </div>
                        </div>
                        <div class="control-buttons">
                            <button class="btn btn-on" onclick="controlRelayById('${relay.id}', true)" id="relay${relay.id}On">å¼€å¯</button>
                            <button class="btn btn-off" onclick="controlRelayById('${relay.id}', false)" id="relay${relay.id}Off">å…³é—­</button>
                            <button class="btn btn-toggle" onclick="toggleRelayById('${relay.id}')" id="relay${relay.id}Toggle">åˆ‡æ¢çŠ¶æ€</button>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="device-item-btn edit" onclick="showEditRelayModal('${relay.id}')" title="ç¼–è¾‘">âœï¸</button>
                            <button class="device-item-btn delete" onclick="deleteRelay('${relay.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ·»åŠ "æ·»åŠ ç»§ç”µå™¨"æŒ‰é’®
            const addButton = `
                <div class="relay-card" style="text-align: center; cursor: pointer;" onclick="showAddRelayModal()">
                    <div style="font-size: 3rem; color: #7f8c8d; margin: 20px 0;">+</div>
                    <div style="font-size: 1.2rem; color: #7f8c8d;">æ·»åŠ ç»§ç”µå™¨</div>
                </div>
            `;
            
            relayControls.innerHTML = relayCards + addButton;
        }

        // ç»§ç”µå™¨æ§åˆ¶å‡½æ•°
        function controlRelayById(relayId, state) {
            if (!currentDeviceId || !mqttClient || !isConnected) {
                showNotification('è¯·å…ˆé€‰æ‹©è®¾å¤‡å¹¶ç¡®ä¿MQTTè¿æ¥æ­£å¸¸', 'error');
                return;
            }
            
            const relays = getCurrentDeviceRelays();
            const relay = relays.find(r => r.id === relayId);
            
            if (!relay) {
                showNotification('ç»§ç”µå™¨ä¸å­˜åœ¨', 'error');
                return;
            }
            
            try {
                // æ„å»ºæ§åˆ¶å‘½ä»¤
                const command = {
                    gpio: relay.gpio,
                    action: state ? "open" : "close"
                };
                
                // æ‰“å°æ§åˆ¶å°æ—¥å¿—
                console.log(`[å‘½ä»¤ä¸‹å‘] ç»§ç”µå™¨æ§åˆ¶å‘½ä»¤:`, {
                    deviceId: currentDeviceId,
                    topic: `${currentDeviceId}/sub`,
                    command: command,
                    relayName: relay.name,
                    action: state
                });
                
                // å‘é€MQTTå‘½ä»¤
                mqttClient.publish(`${currentDeviceId}/sub`, JSON.stringify(command));
                
                // æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆå‡è®¾æ§åˆ¶æˆåŠŸï¼‰
                relay.state = state;
                saveRelays();
                
                // æ›´æ–°UIæ˜¾ç¤º
                renderRelayControls();
                
                showNotification(`ç»§ç”µå™¨"${relay.name}"${state ? 'å¼€å¯' : 'å…³é—­'}å‘½ä»¤å·²å‘é€`, 'success');
                
            } catch (error) {
                console.error('æ§åˆ¶ç»§ç”µå™¨å¤±è´¥:', error);
                showNotification('æ§åˆ¶ç»§ç”µå™¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        function toggleRelayById(relayId) {
            const relays = getCurrentDeviceRelays();
            const relay = relays.find(r => r.id === relayId);
            
            if (relay) {
                // åˆ‡æ¢çŠ¶æ€
                controlRelayById(relayId, !relay.state);
            }
        }

        // è®¾å¤‡ç®¡ç†å¯¹è¯æ¡†å‡½æ•°
        function showAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.add('show');
            document.getElementById('deviceNameInput').focus();
        }

        function hideAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.remove('show');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('deviceNameInput').value = '';
            document.getElementById('deviceIdInput').value = '';
        }

        function saveNewDevice() {
            const name = document.getElementById('deviceNameInput').value.trim();
            const id = document.getElementById('deviceIdInput').value.trim();

            if (!name || !id) {
                showNotification('è¯·å¡«å†™è®¾å¤‡åç§°å’ŒID', 'error');
                return;
            }

            // æ£€æŸ¥è®¾å¤‡IDæ˜¯å¦å·²å­˜åœ¨
            if (devices.find(d => d.id === id)) {
                showNotification('è®¾å¤‡IDå·²å­˜åœ¨', 'error');
                return;
            }

            const newDevice = {
                id: id,
                name: name
            };

            devices.push(newDevice);
            saveDevices();
            hideAddDeviceModal();
            renderDeviceList();
            selectDevice(id);
            showNotification('è®¾å¤‡æ·»åŠ æˆåŠŸ', 'success');
        }

        function editDevice(deviceId, event) {
            event.stopPropagation();
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                document.getElementById('editDeviceNameInput').value = device.name;
                document.getElementById('editDeviceIdInput').value = device.id;
                
                // ä¿å­˜å½“å‰ç¼–è¾‘çš„è®¾å¤‡ID
                document.getElementById('editDeviceModal').dataset.editingDeviceId = deviceId;
                document.getElementById('editDeviceModal').classList.add('show');
            }
        }

        function hideEditDeviceModal() {
            document.getElementById('editDeviceModal').classList.remove('show');
        }

        function saveEditedDevice() {
            const deviceId = document.getElementById('editDeviceModal').dataset.editingDeviceId;
            const device = devices.find(d => d.id === deviceId);
            
            if (device) {
                device.name = document.getElementById('editDeviceNameInput').value.trim();
                
                saveDevices();
                hideEditDeviceModal();
                renderDeviceList();
                
                // å¦‚æœå½“å‰é€‰ä¸­çš„è®¾å¤‡è¢«ç¼–è¾‘ï¼Œæ›´æ–°æ˜¾ç¤º
                if (currentDeviceId === deviceId) {
                    document.getElementById('currentDeviceName').textContent = device.name;
                }
                
                showNotification('è®¾å¤‡ä¿¡æ¯å·²æ›´æ–°', 'success');
            }
        }

        function deleteDevice(deviceId, event) {
            event.stopPropagation();
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¾å¤‡å—ï¼Ÿ')) {
                devices = devices.filter(d => d.id !== deviceId);
                saveDevices();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„è®¾å¤‡ï¼Œé€‰æ‹©å¦ä¸€ä¸ªè®¾å¤‡
                if (currentDeviceId === deviceId) {
                    if (devices.length > 0) {
                        selectDevice(devices[0].id);
                    } else {
                        currentDeviceId = '';
                        document.getElementById('currentDeviceName').textContent = 'è¯·é€‰æ‹©è®¾å¤‡';
                        document.getElementById('relayControls').innerHTML = '<div class="no-device-selected"><p>è¯·åœ¨å·¦ä¾§é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡</p></div>';
                    }
                }
                
                renderDeviceList();
                showNotification('è®¾å¤‡å·²åˆ é™¤', 'success');
            }
        }

        function editCurrentDevice() {
            if (currentDeviceId) {
                editDevice(currentDeviceId, {stopPropagation: () => {}});
            }
        }

        function removeCurrentDevice() {
            if (currentDeviceId) {
                deleteDevice(currentDeviceId, {stopPropagation: () => {}});
            }
        }

        // é‡å¯å½“å‰è®¾å¤‡
        function restartDevice() {
            if (!currentDeviceId) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦é‡å¯çš„è®¾å¤‡', 'error');
                return;
            }
            
            if (!mqttClient || !isConnected) {
                showNotification('MQTTè¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•é‡å¯è®¾å¤‡', 'error');
                return;
            }
            
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) {
                showNotification('è®¾å¤‡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦é‡å¯è®¾å¤‡ "${device.name}" å—ï¼Ÿè®¾å¤‡å°†æ–­å¼€è¿æ¥å¹¶é‡æ–°å¯åŠ¨ã€‚`)) {
                try {
                    // å‘é€é‡å¯å‘½ä»¤
                    const command = {
                        command: "reboot"
                    };
                    
                    // æ‰“å°æ§åˆ¶å°æ—¥å¿—
                    console.log(`[å‘½ä»¤ä¸‹å‘] è®¾å¤‡é‡å¯å‘½ä»¤:`, {
                        deviceId: device.id,
                        deviceName: device.name,
                        topic: `${device.id}/sub`,
                        command: command
                    });
                    
                    mqttClient.publish(`${device.id}/sub`, JSON.stringify(command));
                    showNotification(`æ­£åœ¨é‡å¯è®¾å¤‡ "${device.name}"...`, 'info');
                    
                    // ç›‘æ§è®¾å¤‡é‡æ–°ä¸Šçº¿
                    monitorDeviceReconnection(device.id);
                    
                } catch (error) {
                    console.error('é‡å¯è®¾å¤‡å¤±è´¥:', error);
                    showNotification('é‡å¯è®¾å¤‡å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        function refreshAllDevices() {
            devices.forEach(device => {
                console.log('åˆ·æ–°è®¾å¤‡çŠ¶æ€:', device.id);
            });
            
            showNotification('æ­£åœ¨åˆ·æ–°æ‰€æœ‰è®¾å¤‡çŠ¶æ€', 'info');
        }

        // MQTTè¿æ¥
        function connectMQTT() {
            if (typeof mqtt === 'undefined') {
                showNotification('MQTTåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                return;
            }

            const protocol = config.mqtt_ssl ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${config.mqtt_host}:${config.mqtt_port}${config.mqtt_path ? '/' + config.mqtt_path : ''}`;
            const clientId = 'web_client_' + Math.random().toString(16).substr(2, 8);
            
            try {
                console.log('å°è¯•è¿æ¥MQTT:', wsUrl);
                
                const options = {
                    clientId: clientId,
                    username: config.mqtt_user,
                    password: config.mqtt_pwd,
                    clean: true,
                    reconnectPeriod: 3000,
                    connectTimeout: 3000
                };
                
                mqttClient = mqtt.connect(wsUrl, options);
                
                mqttClient.on('connect', onConnect);
                mqttClient.on('message', onMessageArrived);
                mqttClient.on('error', onConnectFailure);
                mqttClient.on('close', onConnectionLost);
                
                updateStatus('æ­£åœ¨è¿æ¥...', false);
                
            } catch (error) {
                console.error('MQTTè¿æ¥é”™è¯¯:', error);
                showNotification('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                updateStatus('è¿æ¥å¤±è´¥', false);
            }
        }

        function onConnect() {
            console.log('MQTTè¿æ¥æˆåŠŸ');
            isConnected = true;
            updateStatus('å·²è¿æ¥', true);
            showNotification('MQTTè¿æ¥æˆåŠŸ', 'success');
            
            subscribeToAllDevices();

        }

        function subscribeToAllDevices() {
            if (!mqttClient || !isConnected) return;
            
            devices.forEach(device => {
                // è®¢é˜…è®¾å¤‡å‘å¸ƒä¸»é¢˜ï¼Œæ¥æ”¶GPIOçŠ¶æ€
                mqttClient.subscribe(`${device.id}/pub`, (err) => {
                    if (!err) {
                        console.log(`å·²è®¢é˜…è®¾å¤‡ ${device.id} çŠ¶æ€å‘å¸ƒä¸»é¢˜`);
                    }
                });
                
                // è®¢é˜…è®¾å¤‡çŠ¶æ€ä¸»é¢˜ï¼Œæ¥æ”¶å¿ƒè·³
                mqttClient.subscribe(`${device.id}/status`, (err) => {
                    if (!err) {
                        console.log(`å·²è®¢é˜…è®¾å¤‡ ${device.id} å¿ƒè·³ä¸»é¢˜`);
                    }
                });
            });
        }

        function onConnectFailure(error) {
            console.error('MQTTè¿æ¥å¤±è´¥:', error);
            isConnected = false;
            updateStatus('è¿æ¥å¤±è´¥', false);
            showNotification('è¿æ¥å¤±è´¥: ' + error.errorMessage, 'error');
            
            // 5ç§’åé‡è¯•
            setTimeout(connectMQTT, 5000);
        }

        function onConnectionLost(response) {
            console.log('MQTTè¿æ¥ä¸¢å¤±:', response);
            isConnected = false;
            updateStatus('è¿æ¥æ–­å¼€', false);
            showNotification('è¿æ¥å·²æ–­å¼€', 'error');
            
            // å°è¯•é‡è¿
            setTimeout(connectMQTT, 3000);
        }

        function onMessageArrived(topic, message) {
            try {
                const deviceId = topic.split('/')[0];
                
                if (topic.endsWith('/status')) {
                    // å¤„ç†å¿ƒè·³æ¶ˆæ¯ - ä¸æ‰“å°åˆ°æ§åˆ¶å°
                    // åªè¦æ”¶åˆ°å¿ƒè·³å°±è®¤ä¸ºè®¾å¤‡åœ¨çº¿
                    updateDeviceOnlineStatus(deviceId, true);
                    
                } else if (topic.endsWith('/pub')) {
                    // å¤„ç†è®¾å¤‡çŠ¶æ€æ¶ˆæ¯
                    console.log('[æ”¶åˆ°è®¾å¤‡çŠ¶æ€]:', topic, message.toString());
                    
                    const data = JSON.parse(message.toString());
                    
                    // ä»è®¾å¤‡å‘å¸ƒä¸»é¢˜æ¥æ”¶GPIOçŠ¶æ€
                    if (deviceId === currentDeviceId) {
                        updateRelayStates(data);
                    }
                    // åªè¦æ”¶åˆ°pubä¸»é¢˜æ•°æ®å°±è®¤ä¸ºè®¾å¤‡åœ¨çº¿
                    updateDeviceOnlineStatus(deviceId, true);
                    
                } else {
                    // å…¶ä»–æ¶ˆæ¯æ‰“å°åˆ°æ§åˆ¶å°
                    console.log('[æ”¶åˆ°è®¾å¤‡æ¶ˆæ¯]:', topic, message.toString());
                }
                
            } catch (error) {
                console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
            }
        }

        // æ›´æ–°è®¾å¤‡åœ¨çº¿çŠ¶æ€
        function updateDeviceOnlineStatus(deviceId, isOnline) {
            if (!deviceStatus[deviceId]) {
                deviceStatus[deviceId] = {};
            }
            
            // æ›´æ–°åœ¨çº¿çŠ¶æ€å’Œæœ€åå¿ƒè·³æ—¶é—´
            deviceStatus[deviceId].online = isOnline;
            deviceStatus[deviceId].lastPing = Date.now();
            
            // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
            renderDeviceList();
        }

        // æ£€æŸ¥è®¾å¤‡å¿ƒè·³è¶…æ—¶ï¼ˆè¶…è¿‡5ç§’æ²¡æœ‰å¿ƒè·³è®¤ä¸ºç¦»çº¿ï¼‰
        function checkDeviceTimeout() {
            const currentTime = Date.now();
            const timeout = 5000; // 5ç§’è¶…æ—¶
            
            devices.forEach(device => {
                if (deviceStatus[device.id] && deviceStatus[device.id].lastPing) {
                    const timeSinceLastPing = currentTime - deviceStatus[device.id].lastPing;
                    
                    if (timeSinceLastPing > timeout && deviceStatus[device.id].online) {
                        // è¶…æ—¶ä¸”å½“å‰çŠ¶æ€ä¸ºåœ¨çº¿ï¼Œæ›´æ–°ä¸ºç¦»çº¿
                        deviceStatus[device.id].online = false;
                        console.log(`è®¾å¤‡ ${device.id} å¿ƒè·³è¶…æ—¶ï¼Œæ ‡è®°ä¸ºç¦»çº¿`);
                        renderDeviceList();
                    }
                }
            });
        }

        // æ›´æ–°ç»§ç”µå™¨çŠ¶æ€æ˜¾ç¤º
        function updateRelayStates(data) {
            if (!currentDeviceId) return;
            
            const relays = getCurrentDeviceRelays();
            
            // éå†æ‰€æœ‰GPIOçŠ¶æ€æ•°æ®
            Object.keys(data).forEach(gpioKey => {
                // åªå¤„ç†gpioå‰ç¼€çš„å­—æ®µ
                if (!gpioKey.startsWith('gpio')) return;
                
                // æå–GPIOç¼–å·ï¼ˆå¦‚"gpio24"ä¸­çš„24ï¼‰
                const gpioNum = parseInt(gpioKey.replace('gpio', ''));
                
                // æŸ¥æ‰¾å¯¹åº”çš„ç»§ç”µå™¨
                const relay = relays.find(r => r.gpio === gpioNum);
                if (!relay || data[gpioKey] === undefined) return;
                
                // é«˜ç”µå¹³ä¸º1è¡¨ç¤ºå¼€ï¼Œä½ç”µå¹³ä¸º0è¡¨ç¤ºå…³
                const isOn = data[gpioKey] === 1;
                
                // æ›´æ–°ç»§ç”µå™¨æœ¬åœ°çŠ¶æ€
                relay.state = isOn;
                
                // æ›´æ–°UIæ˜¾ç¤º
                const relayState = document.getElementById(`relay${relay.id}State`);
                const relayLed = document.getElementById(`relay${relay.id}Led`);
                const relayOn = document.getElementById(`relay${relay.id}On`);
                const relayOff = document.getElementById(`relay${relay.id}Off`);
                
                if (relayState) {
                    relayState.textContent = isOn ? 'è®¾å¤‡è¿è¡Œä¸­' : 'è®¾å¤‡å·²å…³é—­';
                    relayState.className = `state-text ${isOn ? 'on' : 'off'}`;
                }
                
                if (relayLed) {
                    relayLed.className = `state-led ${isOn ? 'on' : 'off'}`;
                }
                
                if (relayOn && relayOff) {
                    relayOn.disabled = isOn;
                    relayOff.disabled = !isOn;
                }
            });
            
            // ä¿å­˜æ›´æ–°åçš„ç»§ç”µå™¨çŠ¶æ€
            saveRelays();
        }

        // å¤„ç†å‘½ä»¤å“åº”ï¼ˆå·²å¼ƒç”¨ï¼Œä¿ç•™ä»¥é˜²æ—§ä»£ç è°ƒç”¨ï¼‰
        function handleCommandResponse(data) {
            console.log('[å·²å¼ƒç”¨] handleCommandResponseè¢«è°ƒç”¨:', data);
            // è¿™ä¸ªå‡½æ•°å·²ç»è¢«updateRelayStatesæ›¿ä»£ï¼Œä¸å†éœ€è¦
        }

        // controlRelayå‡½æ•°å·²è¢«controlRelayByIdæ›¿ä»£ï¼Œåˆ é™¤å†—ä½™ä»£ç 

        // getCurrentDeviceStatuså‡½æ•°å·²ç§»é™¤ï¼Œè®¾å¤‡çŠ¶æ€é€šè¿‡/pubä¸»é¢˜æ•°æ®è‡ªåŠ¨æ›´æ–°

        // ç•Œé¢æ§åˆ¶
        function updateStatus(text, connected) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (indicator && statusText) {
                indicator.className = `status-indicator ${connected ? 'connected' : ''}`;
                statusText.textContent = text;
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification show ${type}`;
                
                setTimeout(() => {
                    notification.className = 'notification';
                }, 3000);
            }
        }

        // ç»§ç”µå™¨åç§°ç¼–è¾‘
        function editRelayName(relayNum) {
            document.getElementById('editingRelayNum').textContent = relayNum;
            document.getElementById('relayNameInput').value = `ç»§ç”µå™¨ ${relayNum}`;
            document.getElementById('relayNameModal').dataset.editingRelayNum = relayNum;
            document.getElementById('relayNameModal').classList.add('show');
        }

        function hideRelayName() {
            document.getElementById('relayNameModal').classList.remove('show');
        }

        function saveRelayName() {
            const relayNum = parseInt(document.getElementById('relayNameModal').dataset.editingRelayNum);
            const newName = document.getElementById('relayNameInput').value.trim();
            
            if (newName) {
                // ç»§ç”µå™¨åç§°å·²ç§»é™¤é…ç½®
                saveConfig();
                
                const relayTitle = document.querySelector(`#relay${relayNum}Card .relay-title`);
                if (relayTitle) {
                    relayTitle.textContent = newName;
                }
                
                hideRelayName();
                showNotification('ç»§ç”µå™¨åç§°å·²æ›´æ–°', 'success');
            }
        }

        // MQTTé…ç½®
        function showMqttConfig() {
            document.getElementById('mqttHost').value = config.mqtt_host || '';
            document.getElementById('mqttPort').value = config.mqtt_port || '';
            document.getElementById('mqttPath').value = config.mqtt_path || '';
            document.getElementById('mqttUser').value = config.mqtt_user || '';
            document.getElementById('mqttPassword').value = config.mqtt_pwd || '';
            document.getElementById('mqttSSL').checked = config.mqtt_ssl || false;
            
            document.getElementById('mqttConfigModal').classList.add('show');
        }

        function hideMqttConfig() {
            document.getElementById('mqttConfigModal').classList.remove('show');
        }

        function saveMqttConfig() {
            config.mqtt_host = document.getElementById('mqttHost').value.trim();
            config.mqtt_port = parseInt(document.getElementById('mqttPort').value);
            config.mqtt_path = document.getElementById('mqttPath').value.trim() || 'mqtt';
            config.mqtt_user = document.getElementById('mqttUser').value.trim();
            config.mqtt_pwd = document.getElementById('mqttPassword').value.trim();
            config.mqtt_ssl = document.getElementById('mqttSSL').checked;
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!config.mqtt_host || !config.mqtt_port || !config.mqtt_user || !config.mqtt_pwd) {
                showNotification('è¯·å¡«å†™å®Œæ•´çš„MQTTé…ç½®ä¿¡æ¯ï¼ˆæœåŠ¡å™¨åœ°å€ã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ï¼‰', 'error');
                return;
            }
            
            saveConfig();
            hideMqttConfig();
            
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
            
            setTimeout(() => {
                connectMQTT();
            }, 1000);
            
            showNotification('MQTTé…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨é‡æ–°è¿æ¥...', 'info');
        }

        // è®¾å¤‡é…ç½®ä¸‹å‘åŠŸèƒ½
        function editDeviceInfo() {
            if (currentDeviceId) {
                editDevice(currentDeviceId, {stopPropagation: () => {}});
            } else {
                showNotification('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„è®¾å¤‡', 'error');
            }
        }

        // é…ç½®ä¸‹å‘åŠŸèƒ½å·²ç§»é™¤

        // monitorDeviceReconnectionå‡½æ•°å·²ç§»é™¤ï¼Œé…ç½®ä¸‹å‘åŠŸèƒ½å·²ç¦ç”¨

        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å®šæœŸæ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
            setInterval(() => {
                Object.keys(deviceStatus).forEach(deviceId => {
                    if (deviceStatus[deviceId].online && 
                        Date.now() - deviceStatus[deviceId].lastPing > 60000) {
                        deviceStatus[deviceId].online = false;
                        renderDeviceList();
                        
                        if (deviceId === currentDeviceId) {
                            showNotification(`è®¾å¤‡ ${deviceId} å·²ç¦»çº¿`, 'error');
                        }
                    }
                });
            }, 30000);
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'n':
                            e.preventDefault();
                            showAddDeviceModal();
                            break;
                        case 'r':
                            e.preventDefault();
                            refreshAllDevices();
                            break;
                        case 'e':
                            e.preventDefault();
                            editCurrentDevice();
                            break;
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>