<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šè®¾å¤‡ç»§ç”µå™¨æ§åˆ¶ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            display: flex;
            min-height: 600px;
            height: calc(100vh - 40px);
        }

        /* å·¦ä¾§è®¾å¤‡åˆ—è¡¨æ ·å¼ */
        .device-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .sidebar-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .add-device-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .add-device-btn:hover {
            background: #2980b9;
        }

        .device-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .device-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .device-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .device-item.active {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .device-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .device-id {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .device-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator-small {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator-small.online {
            background: #2ecc71;
        }

        .status-indicator-large {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator-large.online {
            background: #2ecc71;
        }

        .status-text {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .device-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .device-item:hover .device-actions {
            opacity: 1;
        }

        .device-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .device-item:hover .device-actions {
            opacity: 1;
        }

        .device-item-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background 0.3s ease;
        }

        .device-item-btn:hover {
            background: #3498db;
            color: white;
        }

        .device-item-btn.edit {
            background: #f39c12;
            color: white;
        }

        .device-item-btn.delete {
            background: #e74c3c;
            color: white;
        }

        /* å³ä¾§ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* é¡µé¢å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* è®¾å¤‡æ§åˆ¶åŒºåŸŸ */
        .control-section {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        /* è®¾å¤‡å¤´éƒ¨æ ·å¼ */
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .device-header h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin: 0;
            font-weight: 600;
        }

        .device-header-actions {
            display: flex;
            gap: 10px;
        }

        .device-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
            white-space: nowrap;
            height: 40px;
        }

        .device-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .device-btn.edit {
            background: #f39c12;
        }

        .device-btn.edit:hover {
            background: #e67e22;
        }

        .device-btn.config {
            background: #9b59b6;
        }

        .device-btn.config:hover {
            background: #8e44ad;
        }

        .device-btn.delete {
            background: #e74c3c;
        }

        .device-btn.delete:hover {
            background: #c0392b;
        }

        .device-btn.refresh {
            background: #2ecc71;
        }

        .device-btn.refresh:hover {
            background: #27ae60;
        }

        .device-btn.restart {
            background: #f39c12;
        }

        .device-btn.restart:hover {
            background: #e67e22;
        }

        /* ç»§ç”µå™¨æ§åˆ¶é¢æ¿ */
        .relay-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .no-device-selected {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
            font-size: 1.2rem;
            grid-column: 1 / -1;
        }

        /* ç»§ç”µå™¨æ§åˆ¶å¡æ ·å¼ */
        .relay-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        .relay-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .relay-card.active {
            border-color: #3498db;
        }

        .relay-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .relay-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .relay-title:hover {
            color: #3498db;
        }

        .relay-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }

        .relay1-icon {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .relay2-icon {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        }

        .relay-state {
            text-align: center;
            margin: 20px 0;
        }

        .state-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .state-led {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #95a5a6;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(149, 165, 166, 0.3);
        }

        .state-led.on {
            background: #2ecc71;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.6);
            animation: pulse 2s infinite;
        }

        .state-led.off {
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(46, 204, 113, 0.6); }
            50% { box-shadow: 0 0 25px rgba(46, 204, 113, 0.8); }
            100% { box-shadow: 0 0 20px rgba(46, 204, 113, 0.6); }
        }

        .state-text {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            background: #f8f9fa;
            color: #2c3e50;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .state-text.on {
            background: #d5f4e6;
            color: #27ae60;
            border-color: #2ecc71;
        }

        .state-text.off {
            background: #fadbd8;
            color: #c0392b;
            border-color: #e74c3c;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-on {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-on:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-off {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
        }

        .btn-off:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-toggle {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: white;
            grid-column: 1 / -1;
        }

        .btn-toggle:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: white;
            margin-top: auto;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .form-notice {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .device-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .relay-controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§è®¾å¤‡åˆ—è¡¨ -->
        <div class="device-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ğŸ“± è®¾å¤‡åˆ—è¡¨</div>
                <button class="add-device-btn" onclick="showAddDeviceModal()">+ æ·»åŠ è®¾å¤‡</button>
            </div>
            <div class="device-list" id="deviceList">
                <!-- è®¾å¤‡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡µé¢å¤´éƒ¨ -->
            <div class="header">
                <div class="header-controls">
                    <button class="header-btn" onclick="showMqttConfig()">âš™ï¸ MQTTè®¾ç½®</button>
                </div>
                <h1>ğŸ”Œ å¤šè®¾å¤‡ç»§ç”µå™¨æ§åˆ¶ç³»ç»Ÿ</h1>
                <p>åŸºäº MQTT åè®®çš„ç‰©è”ç½‘è®¾å¤‡è¿œç¨‹æ§åˆ¶</p>
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">è¿æ¥æ–­å¼€</span>
                </div>
            </div>

            <!-- è®¾å¤‡æ§åˆ¶åŒºåŸŸ -->
            <div class="control-section">
                <!-- å½“å‰è®¾å¤‡ä¿¡æ¯æ  -->
                <div class="device-header">
                    <h2 id="currentDeviceName">è¯·é€‰æ‹©è®¾å¤‡</h2>
                    <div class="device-header-actions">
                        <button class="device-btn edit" onclick="editDeviceInfo()" id="editDeviceBtn">âœï¸ ç¼–è¾‘ä¿¡æ¯</button>
                        <button class="device-btn config" onclick="sendDeviceConfig()" id="configDeviceBtn">âš™ï¸ ä¸‹å‘é…ç½®</button>
                        <button class="device-btn restart" onclick="restartDevice()" id="restartDeviceBtn">ğŸ”„ é‡å¯è®¾å¤‡</button>
                        <button class="device-btn delete" onclick="removeCurrentDevice()" id="removeDeviceBtn">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>

                <!-- ç»§ç”µå™¨æ§åˆ¶é¢æ¿ -->
                <div class="relay-controls" id="relayControls">
                    <div class="no-device-selected">
                        <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡</p>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p>Â© 2024 å¤šè®¾å¤‡ç»§ç”µå™¨æ§åˆ¶ç³»ç»Ÿ | åŸºäºåˆå®™ Air780EP å¼€å‘</p>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥åŒºåŸŸ -->
    <div class="notification" id="notification"></div>

    <!-- MQTTé…ç½®å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="mqttConfigModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">âš™ï¸ MQTTæœåŠ¡å™¨é…ç½®</h3>
                <button class="modal-close" onclick="hideMqttConfig()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">æœåŠ¡å™¨åœ°å€</label>
                <input type="text" class="form-input" id="mqttHost" placeholder="mqttæœåŠ¡å™¨åœ°å€">
            </div>
            <div class="form-group">
                <label class="form-label">ç«¯å£å·</label>
                <input type="number" class="form-input" id="mqttPort" placeholder="WebSocketç«¯å£">
            </div>
            <div class="form-group">
                <label class="form-label">è·¯å¾„ (å¯é€‰)</label>
                <input type="text" class="form-input" id="mqttPath" placeholder="mqtt">
            </div>
            <div class="form-group">
                <label class="form-label">ç”¨æˆ·å</label>
                <input type="text" class="form-input" id="mqttUser" placeholder="ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label class="form-label">å¯†ç </label>
                <input type="password" class="form-input" id="mqttPassword" placeholder="å¯†ç ">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" class="form-checkbox" id="mqttSSL">
                    å¯ç”¨SSLåŠ å¯†
                </label>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideMqttConfig()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveMqttConfig()">ä¿å­˜å¹¶è¿æ¥</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="addDeviceModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“± æ·»åŠ æ–°è®¾å¤‡</h3>
                <button class="modal-close" onclick="hideAddDeviceModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">è®¾å¤‡åç§°</label>
                <input type="text" class="form-input" id="deviceNameInput" placeholder="è¾“å…¥è®¾å¤‡åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">è®¾å¤‡ID (IMEI)</label>
                <input type="text" class="form-input" id="deviceIdInput" placeholder="è¾“å…¥è®¾å¤‡IMEIç ">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddDeviceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveNewDevice()">ä¿å­˜è®¾å¤‡</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è®¾å¤‡å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="editDeviceModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">âœï¸ ç¼–è¾‘è®¾å¤‡</h3>
                <button class="modal-close" onclick="hideEditDeviceModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">è®¾å¤‡åç§°</label>
                <input type="text" class="form-input" id="editDeviceNameInput" placeholder="è¾“å…¥è®¾å¤‡åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">è®¾å¤‡ID (IMEI)</label>
                <input type="text" class="form-input" id="editDeviceIdInput" placeholder="è®¾å¤‡IMEIç " readonly>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideEditDeviceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEditedDevice()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- ç»§ç”µå™¨åç§°ç¼–è¾‘å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="relayNameModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“ ä¿®æ”¹ç»§ç”µå™¨åç§°</h3>
                <button class="modal-close" onclick="hideRelayName()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">ç»§ç”µå™¨ <span id="editingRelayNum">1</span> çš„æ–°åç§°</label>
                <input type="text" class="form-input" id="relayNameInput" placeholder="è¾“å…¥ç»§ç”µå™¨åç§°">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideRelayName()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveRelayName()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- é…ç½®ä¸‹å‘å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="configDeviceModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">âš™ï¸ ä¸‹å‘é…ç½®åˆ°è®¾å¤‡</h3>
                <button class="modal-close" onclick="hideConfigDeviceModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">ç›®æ ‡è®¾å¤‡</label>
                <input type="text" class="form-input" id="configDeviceId" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">MQTTæœåŠ¡å™¨åœ°å€</label>
                <input type="text" class="form-input" id="configMqttHost" placeholder="mqttæœåŠ¡å™¨åœ°å€">
            </div>
            <div class="form-group">
                <label class="form-label">ç«¯å£å·</label>
                <input type="number" class="form-input" id="configMqttPort" placeholder="MQTTç«¯å£">
            </div>
            <div class="form-group">
                <label class="form-label">ç”¨æˆ·å</label>
                <input type="text" class="form-input" id="configMqttUser" placeholder="MQTTç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label class="form-label">å¯†ç </label>
                <input type="password" class="form-input" id="configMqttPassword" placeholder="MQTTå¯†ç ">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" class="form-checkbox" id="configMqttSSL">
                    å¯ç”¨SSLåŠ å¯†
                </label>
            </div>
            <div class="form-notice">
                <p style="color: #e74c3c; font-size: 0.9rem; background: #fff8f8; padding: 10px; border-radius: 5px; border-left: 3px solid #e74c3c;">
                    âš ï¸ è­¦å‘Šï¼šä¸‹å‘é…ç½®åè®¾å¤‡å°†é‡å¯å¹¶é‡æ–°è¿æ¥MQTTæœåŠ¡å™¨
                </p>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideConfigDeviceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmSendConfig()">ç¡®è®¤ä¸‹å‘</button>
            </div>
        </div>
    </div>

    <script>
        // é»˜è®¤é…ç½®
        const DEFAULT_CONFIG = {
            mqtt_host: '120.25.229.70',
            mqtt_port: 8083,
            mqtt_path: 'mqtt',
            mqtt_user: 'super-sms',
            mqtt_pwd: 'super-sms',
            mqtt_ssl: false,
            relay_names: ['ç»§ç”µå™¨ 1', 'ç»§ç”µå™¨ 2']
        };

        // å…¨å±€å˜é‡
        let mqttClient = null;
        let currentDeviceId = ''; // å½“å‰é€‰ä¸­çš„è®¾å¤‡ID
        let isConnected = false;
        let config = {...DEFAULT_CONFIG};
        
        // è®¾å¤‡ç®¡ç†
        let devices = [];
        let deviceStatus = {}; // è®¾å¤‡åœ¨çº¿çŠ¶æ€ {'device_id': {online: true, lastPing: timestamp}}

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            console.log('åˆå§‹åŒ–å¤šè®¾å¤‡ç»§ç”µå™¨æ§åˆ¶ç³»ç»Ÿ...');
            loadConfig();
            loadDevices();
            setupEventListeners();
            
            // ç­‰å¾…MQTTåº“åŠ è½½å®Œæˆ
            if (typeof mqtt !== 'undefined') {
                connectMQTT();
            } else {
                console.log('ç­‰å¾…MQTTåº“åŠ è½½...');
                setTimeout(() => {
                    if (typeof mqtt !== 'undefined') {
                        connectMQTT();
                    } else {
                        showNotification('MQTTåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                    }
                }, 2000);
            }
        }

        // é…ç½®ç®¡ç†å‡½æ•°
        function loadConfig() {
            const saved = localStorage.getItem('relay_control_config');
            if (saved) {
                try {
                    config = {...DEFAULT_CONFIG, ...JSON.parse(saved)};
                    console.log('é…ç½®å·²åŠ è½½:', config);
                } catch (e) {
                    console.error('é…ç½®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', e);
                    config = {...DEFAULT_CONFIG};
                }
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
                config = {...DEFAULT_CONFIG};
                console.log('ä½¿ç”¨é»˜è®¤é…ç½®:', config);
            }
        }

        function saveConfig() {
            localStorage.setItem('relay_control_config', JSON.stringify(config));
            console.log('é…ç½®å·²ä¿å­˜:', config);
        }

        // è®¾å¤‡ç®¡ç†å‡½æ•°
        function loadDevices() {
            const saved = localStorage.getItem('relay_control_devices');
            if (saved) {
                try {
                    devices = JSON.parse(saved);
                    console.log('è®¾å¤‡åˆ—è¡¨å·²åŠ è½½:', devices);
                    renderDeviceList();
                    
                    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªè®¾å¤‡
                    if (devices.length > 0) {
                        selectDevice(devices[0].id);
                    }
                } catch (e) {
                    console.error('è®¾å¤‡åˆ—è¡¨åŠ è½½å¤±è´¥:', e);
                    devices = [];
                }
            }
        }

        function saveDevices() {
            localStorage.setItem('relay_control_devices', JSON.stringify(devices));
            console.log('è®¾å¤‡åˆ—è¡¨å·²ä¿å­˜:', devices);
        }

        function renderDeviceList() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';
            
            devices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = `device-item ${device.id === currentDeviceId ? 'active' : ''}`;
                deviceItem.onclick = () => selectDevice(device.id);
                
                const isOnline = deviceStatus[device.id] && deviceStatus[device.id].online;
                
                deviceItem.innerHTML = `
                    <div class="device-actions">
                        <button class="device-item-btn edit" onclick="editDevice('${device.id}', event)" title="ç¼–è¾‘">âœï¸</button>
                        <button class="device-item-btn delete" onclick="deleteDevice('${device.id}', event)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                    <div class="device-name">${device.name}</div>
                    <div class="device-id">ID: ${device.id}</div>
                    <div class="device-status">
                        <div class="status-indicator-large ${isOnline ? 'online' : 'offline'}" title="${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}"></div>
                    </div>
                `;
                
                deviceList.appendChild(deviceItem);
            });
        }

        function selectDevice(deviceId) {
            currentDeviceId = deviceId;
            const device = devices.find(d => d.id === deviceId);
            
            if (device) {
                document.getElementById('currentDeviceName').textContent = device.name;
                renderRelayControls(device);
                
                // åˆ·æ–°è®¾å¤‡çŠ¶æ€
                getCurrentDeviceStatus();
            }
            
            renderDeviceList();
        }

        function renderRelayControls(device) {
            const relayControls = document.getElementById('relayControls');
            
            relayControls.innerHTML = `
                <div class="relay-card" id="relay1Card">
                    <div class="relay-header">
                        <div class="relay-title" onclick="editRelayName(1)">${config.relay_names[0] || 'ç»§ç”µå™¨ 1'}</div>
                        <div class="relay-icon relay1-icon">ğŸ”Œ</div>
                    </div>
                    <div class="relay-state">
                        <div class="state-indicator">
                            <div class="state-led off" id="relay1Led"></div>
                            <span class="state-text off" id="relay1State">è®¾å¤‡å·²å…³é—­</span>
                        </div>
                    </div>
                    <div class="control-buttons">
                        <button class="btn btn-on" onclick="controlRelay(1, true)" id="relay1On">å¼€å¯</button>
                        <button class="btn btn-off" onclick="controlRelay(1, false)" id="relay1Off">å…³é—­</button>
                    </div>
                </div>

                <div class="relay-card" id="relay2Card">
                    <div class="relay-header">
                        <div class="relay-title" onclick="editRelayName(2)">${config.relay_names[1] || 'ç»§ç”µå™¨ 2'}</div>
                        <div class="relay-icon relay2-icon">ğŸ”Œ</div>
                    </div>
                    <div class="relay-state">
                        <div class="state-indicator">
                            <div class="state-led off" id="relay2Led"></div>
                            <span class="state-text off" id="relay2State">è®¾å¤‡å·²å…³é—­</span>
                        </div>
                    </div>
                    <div class="control-buttons">
                        <button class="btn btn-on" onclick="controlRelay(2, true)" id="relay2On">å¼€å¯</button>
                        <button class="btn btn-off" onclick="controlRelay(2, false)" id="relay2Off">å…³é—­</button>
                    </div>
                </div>
            `;
        }

        // è®¾å¤‡ç®¡ç†å¯¹è¯æ¡†å‡½æ•°
        function showAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.add('show');
            document.getElementById('deviceNameInput').focus();
        }

        function hideAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.remove('show');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('deviceNameInput').value = '';
            document.getElementById('deviceIdInput').value = '';
        }

        function saveNewDevice() {
            const name = document.getElementById('deviceNameInput').value.trim();
            const id = document.getElementById('deviceIdInput').value.trim();

            if (!name || !id) {
                showNotification('è¯·å¡«å†™è®¾å¤‡åç§°å’ŒID', 'error');
                return;
            }

            // æ£€æŸ¥è®¾å¤‡IDæ˜¯å¦å·²å­˜åœ¨
            if (devices.find(d => d.id === id)) {
                showNotification('è®¾å¤‡IDå·²å­˜åœ¨', 'error');
                return;
            }

            const newDevice = {
                id: id,
                name: name
            };

            devices.push(newDevice);
            saveDevices();
            hideAddDeviceModal();
            renderDeviceList();
            selectDevice(id);
            showNotification('è®¾å¤‡æ·»åŠ æˆåŠŸ', 'success');
        }

        function editDevice(deviceId, event) {
            event.stopPropagation();
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                document.getElementById('editDeviceNameInput').value = device.name;
                document.getElementById('editDeviceIdInput').value = device.id;
                
                // ä¿å­˜å½“å‰ç¼–è¾‘çš„è®¾å¤‡ID
                document.getElementById('editDeviceModal').dataset.editingDeviceId = deviceId;
                document.getElementById('editDeviceModal').classList.add('show');
            }
        }

        function hideEditDeviceModal() {
            document.getElementById('editDeviceModal').classList.remove('show');
        }

        function saveEditedDevice() {
            const deviceId = document.getElementById('editDeviceModal').dataset.editingDeviceId;
            const device = devices.find(d => d.id === deviceId);
            
            if (device) {
                device.name = document.getElementById('editDeviceNameInput').value.trim();
                
                saveDevices();
                hideEditDeviceModal();
                renderDeviceList();
                
                // å¦‚æœå½“å‰é€‰ä¸­çš„è®¾å¤‡è¢«ç¼–è¾‘ï¼Œæ›´æ–°æ˜¾ç¤º
                if (currentDeviceId === deviceId) {
                    document.getElementById('currentDeviceName').textContent = device.name;
                }
                
                showNotification('è®¾å¤‡ä¿¡æ¯å·²æ›´æ–°', 'success');
            }
        }

        function deleteDevice(deviceId, event) {
            event.stopPropagation();
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¾å¤‡å—ï¼Ÿ')) {
                devices = devices.filter(d => d.id !== deviceId);
                saveDevices();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„è®¾å¤‡ï¼Œé€‰æ‹©å¦ä¸€ä¸ªè®¾å¤‡
                if (currentDeviceId === deviceId) {
                    if (devices.length > 0) {
                        selectDevice(devices[0].id);
                    } else {
                        currentDeviceId = '';
                        document.getElementById('currentDeviceName').textContent = 'è¯·é€‰æ‹©è®¾å¤‡';
                        document.getElementById('relayControls').innerHTML = '<div class="no-device-selected"><p>è¯·åœ¨å·¦ä¾§é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡</p></div>';
                    }
                }
                
                renderDeviceList();
                showNotification('è®¾å¤‡å·²åˆ é™¤', 'success');
            }
        }

        function editCurrentDevice() {
            if (currentDeviceId) {
                editDevice(currentDeviceId, {stopPropagation: () => {}});
            }
        }

        function removeCurrentDevice() {
            if (currentDeviceId) {
                deleteDevice(currentDeviceId, {stopPropagation: () => {}});
            }
        }

        // é‡å¯å½“å‰è®¾å¤‡
        function restartDevice() {
            if (!currentDeviceId) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦é‡å¯çš„è®¾å¤‡', 'error');
                return;
            }
            
            if (!mqttClient || !isConnected) {
                showNotification('MQTTè¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•é‡å¯è®¾å¤‡', 'error');
                return;
            }
            
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) {
                showNotification('è®¾å¤‡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦é‡å¯è®¾å¤‡ "${device.name}" å—ï¼Ÿè®¾å¤‡å°†æ–­å¼€è¿æ¥å¹¶é‡æ–°å¯åŠ¨ã€‚`)) {
                try {
                    // å‘é€é‡å¯å‘½ä»¤
                    const command = {
                        command: "repboot"
                    };
                    
                    mqttClient.publish(`${device.id}/sub`, JSON.stringify(command));
                    showNotification(`æ­£åœ¨é‡å¯è®¾å¤‡ "${device.name}"...`, 'info');
                    
                    // ç›‘æ§è®¾å¤‡é‡æ–°ä¸Šçº¿
                    monitorDeviceReconnection(device.id);
                    
                } catch (error) {
                    console.error('é‡å¯è®¾å¤‡å¤±è´¥:', error);
                    showNotification('é‡å¯è®¾å¤‡å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        function refreshAllDevices() {
            devices.forEach(device => {
                console.log('åˆ·æ–°è®¾å¤‡çŠ¶æ€:', device.id);
            });
            
            if (currentDeviceId) {
                getCurrentDeviceStatus();
            }
            
            showNotification('æ­£åœ¨åˆ·æ–°æ‰€æœ‰è®¾å¤‡çŠ¶æ€', 'info');
        }

        // MQTTè¿æ¥
        function connectMQTT() {
            if (typeof mqtt === 'undefined') {
                showNotification('MQTTåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                return;
            }

            const protocol = config.mqtt_ssl ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${config.mqtt_host}:${config.mqtt_port}${config.mqtt_path ? '/' + config.mqtt_path : ''}`;
            const clientId = 'web_client_' + Math.random().toString(16).substr(2, 8);
            
            try {
                console.log('å°è¯•è¿æ¥MQTT:', wsUrl);
                
                const options = {
                    clientId: clientId,
                    username: config.mqtt_user,
                    password: config.mqtt_pwd,
                    clean: true,
                    reconnectPeriod: 3000,
                    connectTimeout: 3000
                };
                
                mqttClient = mqtt.connect(wsUrl, options);
                
                mqttClient.on('connect', onConnect);
                mqttClient.on('message', onMessageArrived);
                mqttClient.on('error', onConnectFailure);
                mqttClient.on('close', onConnectionLost);
                
                updateStatus('æ­£åœ¨è¿æ¥...', false);
                
            } catch (error) {
                console.error('MQTTè¿æ¥é”™è¯¯:', error);
                showNotification('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                updateStatus('è¿æ¥å¤±è´¥', false);
            }
        }

        function onConnect() {
            console.log('MQTTè¿æ¥æˆåŠŸ');
            isConnected = true;
            updateStatus('å·²è¿æ¥', true);
            showNotification('MQTTè¿æ¥æˆåŠŸ', 'success');
            
            subscribeToAllDevices();
            
            setTimeout(() => {
                if (currentDeviceId) {
                    getCurrentDeviceStatus();
                }
            }, 1000);
        }

        function subscribeToAllDevices() {
            if (!mqttClient || !isConnected) return;
            
            devices.forEach(device => {
                // è®¢é˜…è®¾å¤‡å‘å¸ƒä¸»é¢˜ï¼Œæ¥æ”¶GPIOçŠ¶æ€
                mqttClient.subscribe(`${device.id}/pub`, (err) => {
                    if (!err) {
                        console.log(`å·²è®¢é˜…è®¾å¤‡ ${device.id} çŠ¶æ€å‘å¸ƒä¸»é¢˜`);
                    }
                });
                
                // è®¢é˜…è®¾å¤‡å¿ƒè·³ä¸»é¢˜ï¼Œæ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
                mqttClient.subscribe(`${device.id}/status`, (err) => {
                    if (!err) {
                        console.log(`å·²è®¢é˜…è®¾å¤‡ ${device.id} å¿ƒè·³ä¸»é¢˜`);
                    }
                });
            });
        }

        function onConnectFailure(error) {
            console.error('MQTTè¿æ¥å¤±è´¥:', error);
            isConnected = false;
            updateStatus('è¿æ¥å¤±è´¥', false);
            showNotification('è¿æ¥å¤±è´¥: ' + error.errorMessage, 'error');
            
            // 5ç§’åé‡è¯•
            setTimeout(connectMQTT, 5000);
        }

        function onConnectionLost(response) {
            console.log('MQTTè¿æ¥ä¸¢å¤±:', response);
            isConnected = false;
            updateStatus('è¿æ¥æ–­å¼€', false);
            showNotification('è¿æ¥å·²æ–­å¼€', 'error');
            
            // å°è¯•é‡è¿
            setTimeout(connectMQTT, 3000);
        }

        function onMessageArrived(topic, message) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', topic, message.toString());
            
            try {
                const data = JSON.parse(message.toString());
                
                // æå–è®¾å¤‡ID
                const deviceId = topic.split('/')[0];
                
                if (topic.endsWith('/pub')) {
                    // ä»è®¾å¤‡å‘å¸ƒä¸»é¢˜æ¥æ”¶GPIOçŠ¶æ€
                    if (deviceId === currentDeviceId) {
                        updateRelayStates(data);
                    }
                    // åªè¦æ”¶åˆ°pubä¸»é¢˜æ•°æ®å°±è®¤ä¸ºè®¾å¤‡åœ¨çº¿
                    updateDeviceOnlineStatus(deviceId, true);
                } else if (topic.endsWith('/status')) {
                    // ä»è®¾å¤‡å¿ƒè·³ä¸»é¢˜æ›´æ–°è®¾å¤‡åœ¨çº¿çŠ¶æ€
                    updateDeviceOnlineStatus(deviceId, true);
                }
                
            } catch (error) {
                console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
            }
        }

        // æ›´æ–°è®¾å¤‡åœ¨çº¿çŠ¶æ€
        function updateDeviceOnlineStatus(deviceId, isOnline) {
            if (!deviceStatus[deviceId]) {
                deviceStatus[deviceId] = {};
            }
            
            // åªè¦æ”¶åˆ°statusä¸»é¢˜çš„æ•°æ®å°±è®¤ä¸ºè®¾å¤‡åœ¨çº¿
            deviceStatus[deviceId].online = isOnline;
            
            // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
            renderDeviceList();
        }

        // æ›´æ–°ç»§ç”µå™¨çŠ¶æ€æ˜¾ç¤º
        function updateRelayStates(data) {
            // GPIOç¼–å·æ˜ å°„åˆ°ç»§ç”µå™¨ç¼–å·
            const gpioMap = {37: 1, 38: 2}; // GPIO37å¯¹åº”ç»§ç”µå™¨1ï¼ŒGPIO38å¯¹åº”ç»§ç”µå™¨2
            
            // éå†æ‰€æœ‰GPIOçŠ¶æ€
            Object.keys(data).forEach(gpioKey => {
                // æå–GPIOç¼–å·ï¼ˆå¦‚"gpio37"ä¸­çš„37ï¼‰
                const gpioNum = parseInt(gpioKey.replace('gpio', ''));
                const relayNum = gpioMap[gpioNum];
                
                if (relayNum && data[gpioKey] !== undefined) {
                    // é«˜ç”µå¹³ä¸º1è¡¨ç¤ºå¼€ï¼Œä½ç”µå¹³ä¸º0è¡¨ç¤ºå…³
                    const isOn = data[gpioKey] === 1;
                    
                    const relayState = document.getElementById(`relay${relayNum}State`);
                    const relayOn = document.getElementById(`relay${relayNum}On`);
                    const relayOff = document.getElementById(`relay${relayNum}Off`);
                    
                    if (relayState) {
                        relayState.textContent = isOn ? 'è®¾å¤‡è¿è¡Œä¸­' : 'è®¾å¤‡å·²å…³é—­';
                        relayState.className = `state-text ${isOn ? 'on' : 'off'}`;
                    }
                    
                    const relayLed = document.getElementById(`relay${relayNum}Led`);
                    if (relayLed) {
                        relayLed.className = `state-led ${isOn ? 'on' : 'off'}`;
                    }
                    
                    if (relayOn && relayOff) {
                        relayOn.disabled = isOn;
                        relayOff.disabled = !isOn;
                    }
                }
            });
        }

        // å¤„ç†å‘½ä»¤å“åº”
        function handleCommandResponse(data) {
            if (data.result === 'success') {
                showNotification('æ“ä½œæ‰§è¡ŒæˆåŠŸ', 'success');
                
                // å¦‚æœæ˜¯ç»§ç”µå™¨æ§åˆ¶ï¼Œæ›´æ–°çŠ¶æ€æ˜¾ç¤º
                if (data.relay_num !== undefined && data.state !== undefined) {
                    const relayElement = document.getElementById(`relay${data.relay_num}State`);
                    if (relayElement) {
                        relayElement.textContent = data.state ? 'è®¾å¤‡è¿è¡Œä¸­' : 'è®¾å¤‡å·²å…³é—­';
                        relayElement.className = `state-text ${data.state ? 'on' : 'off'}`;
                    }
                    
                    const relayLed = document.getElementById(`relay${data.relay_num}Led`);
                    if (relayLed) {
                        relayLed.className = `state-led ${data.state ? 'on' : 'off'}`;
                    }
                }
            } else {
                showNotification('æ“ä½œå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }

        // ç»§ç”µå™¨æ§åˆ¶å‡½æ•°
        function controlRelay(relayNum, state) {
            if (!currentDeviceId || !mqttClient || !isConnected) {
                showNotification('è¯·å…ˆè¿æ¥MQTTå¹¶é€‰æ‹©è®¾å¤‡', 'error');
                return;
            }
            
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) {
                showNotification('è®¾å¤‡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // ç»§ç”µå™¨ç¼–å·æ˜ å°„åˆ°GPIOå£
            const gpioMap = {1: 37, 2: 38}; // ç»§ç”µå™¨1å¯¹åº”GPIO37ï¼Œç»§ç”µå™¨2å¯¹åº”GPIO38
            const gpio = gpioMap[relayNum];
            
            if (!gpio) {
                showNotification('æ— æ•ˆçš„ç»§ç”µå™¨ç¼–å·', 'error');
                return;
            }
            
            const command = {
                gpio: gpio,
                action: state ? 'open' : 'close'
            };
            
            try {
                mqttClient.publish(`${device.id}/sub`, JSON.stringify(command));
                showNotification(`æ­£åœ¨${state ? 'å¼€å¯' : 'å…³é—­'}ç»§ç”µå™¨${relayNum} (GPIO${gpio})`, 'info');
            } catch (error) {
                console.error('å‘é€æ§åˆ¶å‘½ä»¤å¤±è´¥:', error);
                showNotification('æ§åˆ¶å‘½ä»¤å‘é€å¤±è´¥', 'error');
            }
        }

        // åˆ‡æ¢ç»§ç”µå™¨çŠ¶æ€
        function toggleRelay(relayNum) {
            if (!currentDeviceId || !mqttClient || !isConnected) {
                showNotification('è¯·å…ˆè¿æ¥MQTTå¹¶é€‰æ‹©è®¾å¤‡', 'error');
                return;
            }
            
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) {
                showNotification('è®¾å¤‡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            const command = {
                command: 'toggle_relay',
                relay_num: relayNum
            };
            
            try {
                mqttClient.publish(`${device.id}/sub`, JSON.stringify(command));
                showNotification(`æ­£åœ¨åˆ‡æ¢ç»§ç”µå™¨${relayNum}çŠ¶æ€`, 'info');
            } catch (error) {
                console.error('å‘é€åˆ‡æ¢å‘½ä»¤å¤±è´¥:', error);
                showNotification('åˆ‡æ¢å‘½ä»¤å‘é€å¤±è´¥', 'error');
            }
        }

        // è·å–å½“å‰è®¾å¤‡çŠ¶æ€
        function getCurrentDeviceStatus() {
            if (!currentDeviceId || !mqttClient || !isConnected) {
                showNotification('è¯·å…ˆè¿æ¥MQTTå¹¶é€‰æ‹©è®¾å¤‡', 'error');
                return;
            }
            
            const command = {
                command: 'get_status'
            };
            
            try {
                mqttClient.publish(`${currentDeviceId}/control`, JSON.stringify(command));
                showNotification('æ­£åœ¨è·å–è®¾å¤‡çŠ¶æ€...', 'info');
            } catch (error) {
                console.error('å‘é€çŠ¶æ€æŸ¥è¯¢å‘½ä»¤å¤±è´¥:', error);
                showNotification('çŠ¶æ€æŸ¥è¯¢å¤±è´¥', 'error');
            }
        }

        // ç•Œé¢æ§åˆ¶
        function updateStatus(text, connected) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (indicator && statusText) {
                indicator.className = `status-indicator ${connected ? 'connected' : ''}`;
                statusText.textContent = text;
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification show ${type}`;
                
                setTimeout(() => {
                    notification.className = 'notification';
                }, 3000);
            }
        }

        // ç»§ç”µå™¨åç§°ç¼–è¾‘
        function editRelayName(relayNum) {
            document.getElementById('editingRelayNum').textContent = relayNum;
            document.getElementById('relayNameInput').value = config.relay_names[relayNum - 1] || `ç»§ç”µå™¨ ${relayNum}`;
            document.getElementById('relayNameModal').dataset.editingRelayNum = relayNum;
            document.getElementById('relayNameModal').classList.add('show');
        }

        function hideRelayName() {
            document.getElementById('relayNameModal').classList.remove('show');
        }

        function saveRelayName() {
            const relayNum = parseInt(document.getElementById('relayNameModal').dataset.editingRelayNum);
            const newName = document.getElementById('relayNameInput').value.trim();
            
            if (newName) {
                config.relay_names[relayNum - 1] = newName;
                saveConfig();
                
                const relayTitle = document.querySelector(`#relay${relayNum}Card .relay-title`);
                if (relayTitle) {
                    relayTitle.textContent = newName;
                }
                
                hideRelayName();
                showNotification('ç»§ç”µå™¨åç§°å·²æ›´æ–°', 'success');
            }
        }

        // MQTTé…ç½®
        function showMqttConfig() {
            document.getElementById('mqttHost').value = config.mqtt_host || '';
            document.getElementById('mqttPort').value = config.mqtt_port || '';
            document.getElementById('mqttPath').value = config.mqtt_path || '';
            document.getElementById('mqttUser').value = config.mqtt_user || '';
            document.getElementById('mqttPassword').value = config.mqtt_pwd || '';
            document.getElementById('mqttSSL').checked = config.mqtt_ssl || false;
            
            document.getElementById('mqttConfigModal').classList.add('show');
        }

        function hideMqttConfig() {
            document.getElementById('mqttConfigModal').classList.remove('show');
        }

        function saveMqttConfig() {
            config.mqtt_host = document.getElementById('mqttHost').value.trim() || DEFAULT_CONFIG.mqtt_host;
            config.mqtt_port = parseInt(document.getElementById('mqttPort').value) || DEFAULT_CONFIG.mqtt_port;
            config.mqtt_path = document.getElementById('mqttPath').value.trim() || DEFAULT_CONFIG.mqtt_path;
            config.mqtt_user = document.getElementById('mqttUser').value.trim() || DEFAULT_CONFIG.mqtt_user;
            config.mqtt_pwd = document.getElementById('mqttPassword').value.trim() || DEFAULT_CONFIG.mqtt_pwd;
            config.mqtt_ssl = document.getElementById('mqttSSL').checked;
            
            saveConfig();
            hideMqttConfig();
            
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
            
            setTimeout(() => {
                connectMQTT();
            }, 1000);
            
            showNotification('MQTTé…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨é‡æ–°è¿æ¥...', 'info');
        }

        // è®¾å¤‡é…ç½®ä¸‹å‘åŠŸèƒ½
        function editDeviceInfo() {
            if (currentDeviceId) {
                editDevice(currentDeviceId, {stopPropagation: () => {}});
            } else {
                showNotification('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„è®¾å¤‡', 'error');
            }
        }

        function sendDeviceConfig() {
            if (!currentDeviceId) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦ä¸‹å‘é…ç½®çš„è®¾å¤‡', 'error');
                return;
            }
            
            if (!mqttClient || !isConnected) {
                showNotification('MQTTè¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•ä¸‹å‘é…ç½®', 'error');
                return;
            }
            
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) {
                showNotification('è®¾å¤‡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // å¡«å……é…ç½®å¯¹è¯æ¡†
            document.getElementById('configDeviceId').value = `${device.name} (${device.id})`;
            document.getElementById('configMqttHost').value = device.mqtt_host || '120.25.229.70';
            document.getElementById('configMqttPort').value = device.mqtt_port || 1883;
            document.getElementById('configMqttUser').value = device.mqtt_user || 'super-sms';
            document.getElementById('configMqttPassword').value = device.mqtt_pwd || 'super-sms';
            document.getElementById('configMqttSSL').checked = false; // é»˜è®¤ä¸å¯ç”¨SSL
            
            // ä¿å­˜å½“å‰è®¾å¤‡IDåˆ°å¯¹è¯æ¡†
            document.getElementById('configDeviceModal').dataset.deviceId = currentDeviceId;
            document.getElementById('configDeviceModal').classList.add('show');
        }

        function hideConfigDeviceModal() {
            document.getElementById('configDeviceModal').classList.remove('show');
        }

        function confirmSendConfig() {
            const deviceId = document.getElementById('configDeviceModal').dataset.deviceId;
            const device = devices.find(d => d.id === deviceId);
            
            if (!device) {
                showNotification('è®¾å¤‡ä¸å­˜åœ¨', 'error');
                hideConfigDeviceModal();
                return;
            }
            
            // è·å–é…ç½®æ•°æ®
            const configData = {
                mqtt_host: document.getElementById('configMqttHost').value.trim(),
                mqtt_port: parseInt(document.getElementById('configMqttPort').value),
                mqtt_user: document.getElementById('configMqttUser').value.trim(),
                mqtt_pwd: document.getElementById('configMqttPassword').value.trim(),
                mqtt_ssl: document.getElementById('configMqttSSL').checked
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!configData.mqtt_host || !configData.mqtt_port) {
                showNotification('è¯·å¡«å†™å®Œæ•´çš„MQTTæœåŠ¡å™¨é…ç½®', 'error');
                return;
            }
            
            // æ„å»ºä¸‹å‘å‘½ä»¤
            const command = {
                command: 'update_config',
                config: configData
            };
            
            try {
                // å‘é€é…ç½®å‘½ä»¤åˆ°è®¾å¤‡
                mqttClient.publish(`${deviceId}/control`, JSON.stringify(command));
                showNotification('æ­£åœ¨ä¸‹å‘é…ç½®åˆ°è®¾å¤‡ï¼Œè®¾å¤‡å°†é‡å¯...', 'info');
                hideConfigDeviceModal();
                
                // ç›‘æ§è®¾å¤‡æ˜¯å¦é‡æ–°ä¸Šçº¿
                monitorDeviceReconnection(deviceId);
                
            } catch (error) {
                console.error('ä¸‹å‘é…ç½®å¤±è´¥:', error);
                showNotification('é…ç½®ä¸‹å‘å¤±è´¥: ' + error.message, 'error');
            }
        }

        function monitorDeviceReconnection(deviceId) {
            const startTime = Date.now();
            const maxWaitTime = 60000; // æœ€å¤šç­‰å¾…60ç§’
            
            const checkInterval = setInterval(() => {
                if (deviceStatus[deviceId] && deviceStatus[deviceId].online) {
                    clearInterval(checkInterval);
                    showNotification(`è®¾å¤‡ ${deviceId} é‡æ–°ä¸Šçº¿ï¼Œé…ç½®æ›´æ–°æˆåŠŸ`, 'success');
                    
                    // æ›´æ–°è®¾å¤‡ä¿¡æ¯
                    const device = devices.find(d => d.id === deviceId);
                    if (device) {
                        device.mqtt_host = document.getElementById('configMqttHost').value.trim();
                        device.mqtt_port = parseInt(document.getElementById('configMqttPort').value);
                        device.mqtt_user = document.getElementById('configMqttUser').value.trim();
                        device.mqtt_pwd = document.getElementById('configMqttPassword').value.trim();
                        saveDevices();
                    }
                } else if (Date.now() - startTime > maxWaitTime) {
                    clearInterval(checkInterval);
                    showNotification(`è®¾å¤‡ ${deviceId} ç­‰å¾…è¶…æ—¶ï¼Œè¯·æ£€æŸ¥è®¾å¤‡çŠ¶æ€`, 'error');
                }
            }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å®šæœŸæ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
            setInterval(() => {
                Object.keys(deviceStatus).forEach(deviceId => {
                    if (deviceStatus[deviceId].online && 
                        Date.now() - deviceStatus[deviceId].lastPing > 60000) {
                        deviceStatus[deviceId].online = false;
                        renderDeviceList();
                        
                        if (deviceId === currentDeviceId) {
                            showNotification(`è®¾å¤‡ ${deviceId} å·²ç¦»çº¿`, 'error');
                        }
                    }
                });
            }, 30000);
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'n':
                            e.preventDefault();
                            showAddDeviceModal();
                            break;
                        case 'r':
                            e.preventDefault();
                            refreshAllDevices();
                            break;
                        case 'e':
                            e.preventDefault();
                            editCurrentDevice();
                            break;
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>